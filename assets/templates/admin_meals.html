{{ template "header" . }}
{{ template "admin_header" . }}
<main class="lyear-layout-content">
	<div class="container-fluid">
		<div class="row">
			<div class="col-lg-12">
				<div class="card">
					<div class="card-header"><h4>订阅列表</h4></div>
					<div class="tab-content">
						<div class="tab-pane active">
							<div class="form-group">
								<div class="table-responsive" >
									<table class="table table-hover table-vcenter">
										<tr>
											<td colspan="5">
												<form class="form-inline" method="post" action="/admin/meals">
													<button class="btn btn-default btn-info meals-add-btn" type="button" data-toggle="modal" onclick="mealsGetCategory(this)" name="addmeal" data-target="#editmeal">新增套餐</button>
												</form>
											</td>
										</tr>
										<tr align="center">
											<td class="w-5">套餐编号</td>
											<td class="w-5">套餐名称</td>
											<td class="w-5">套餐状态</td>
											<td class="w-15">收视内容</td>
											<td class="w-10">操作</td>
										</tr>
										<tbody style="font-size:12px;font-weight: bold;">
										{{ if gt (len .Meals) 0 }}
										{{ $root := . }}
										{{range .Meals}}
											<tr>
												<td class="meal-id" align="center" style="font-size:12px;height:35px;font-weight: bold;" data-value="{{.ID}}">{{.ID}}</td>
												<td class="meal-name" align="center" style="font-size:12px;font-weight: bold;" data-value="{{.Name}}">{{.Name}}</td>
												<td align="center" style="font-size:12px;font-weight: bold;">{{if eq .Status 1 }}<font color="#33a996">上线</font>{{else}}<font color="red">下线</font>{{end}}</td>
												<td class="meal-cids" align="center" style="font-size:12px;font-weight: bold;" data-value="{{ .Content }}">{{ .CaName }}</td>
												<td>
													<button type="button" onclick="tdBtnPOST(this)" name="change_status" value="{{.ID}}" class="btn btn-xs {{if eq .Status 1 }}btn-warning">下线{{else}}btn-success">上线{{end}}</button>
													<button class="btn btn-xs btn-info" type="button" name="editmeal" value="{{.ID}}" data-toggle="modal" onclick="mealsGetCategory(this)" data-target="#editmeal">编辑</button>
													<button class="btn btn-xs btn-info" type="button" onclick="rssPOST(this)" name="rssshow" data-toggle="modal" data-target="#rssshow" value="{{.ID}}">订阅</button>
													<button class="btn btn-xs btn-primary" type="button" onclick="manageTokens(this)" name="managetokens" data-toggle="modal" data-target="#tokenmanager" value="{{.ID}}">Token管理</button>
													{{if eq .ID 1000 }}
													{{else}}
													<button class="btn btn-xs btn-danger" type="button" onclick="tdBtnPOST(this)" name="delmeal" value="{{.ID}}">删除</button>
													{{end}}
												</td>
											</tr>
										{{end}}
										{{else}}
											<tr>
												<td colspan="5" align="center" style="font-size:14px;color:red;height:35px;font-weight: bold;">当前未有套餐数据</td>
											</tr>
										{{end}}
										</tbody>
									</table>
									<div class="modal fade" id="editmeal" tabindex="-1" role="dialog">
										<div class="modal-dialog modal-lg" role="document">
											<div class="modal-content">
												<div class="modal-header">
													<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
													<h4 class="modal-title"></h4>
												</div>
												<form method="post" action="/admin/meals">
													<div class="modal-body">
														<table class="table table-bordered table-striped table-vcenter" align="center">
															<tr>
																<td>
																	<div class="form-inline">
																		<input type="hidden" name="mealId" id="mealId" value="">
																		<label class="control-label">套餐名称：</label>
																		<input class="form-control" type="text" name="mealName" id="mealName" value="">
																	</div>
																</td>
															</tr>
															<tr>
																<td>
																	<label class="lyear-checkbox m-b-10">
																		<input type="checkbox" onclick="checkboxall(this)">
																		<span>全选/反选</span>
																	</label>
																	<div class="form-inline meal-checkbox">
																	</div>
																</td>
															</tr>
														</table>
													</div>
													<div class="modal-footer">
														<button type="button" onclick="submitFormPOST(this)" class="btn btn-primary" id="submitmeal" name="submitmeal">确定</button>
														<button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
													</div>
												</form>
											</div>
										</div>
									</div>
									<div class="modal fade" id="rssshow" tabindex="-1" role="dialog">
										<div class="modal-dialog modal-lg" role="document">
											<div class="modal-content">
												<div class="modal-header">
													<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
													<h4 class="modal-title"></h4>
												</div>
												<div class="modal-body">
													<table class="table table-bordered table-striped table-vcenter" align="center">
														<tr>
															<td>
																<div class="form-group">
																	<button class="btn btn-info" type="button" id="getnewkey" name="getnewkey" value="" data-value="" onclick="getnewkey(this)">刷新KEY</button>
																	<small class="help-block">提示：刷新KEY后之前的链接将不可用</small>
																</div>
															</td>
														</tr>
														<tr>
															<td>
																<div class="form-group">
																	<label class="control-label">TXT订阅：</label>
																	<textarea class="form-control" rows="3" id="rsstxt" readonly ondblclick="CopyRss(this)"></textarea>
																	<small class="help-block">提示：双击复制</small>
																</div>
																<div class="form-group">
																	<label class="control-label">酷9TXT订阅：</label>
																	<textarea class="form-control" rows="3" id="ku9txt" readonly ondblclick="CopyRss(this)"></textarea>
																	<small class="help-block">提示：双击复制</small>
																</div>
																<div class="form-group">
																	<label class="control-label">M3U订阅：</label>
																	<textarea class="form-control" rows="3" id="rssm3u" readonly ondblclick="CopyRss(this)"></textarea>
																	<small class="help-block">提示：双击复制</small>
																</div>
																<div class="form-group">
																	<label class="control-label">EPG订阅：</label>
																	<textarea class="form-control" rows="3" id="rssepg" readonly ondblclick="CopyRss(this)"></textarea>
																	<small class="help-block">提示：双击复制</small>
																</div>
															</td>
														</tr>
													</table>
												</div>
												<div class="modal-footer">
													<button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
												</div>
											</div>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	{{if lt .ChannelNum 1}}
	<script>$.alert({title: '错误',content: '无频道信息，请先添加频道',type: 'red',buttons: {confirm: {text: '确定',btnClass: 'btn-primary',action: function(){loadPage("/admin/channels");}}}});</script>
	{{end}}

	<!-- Token管理模态框 -->
	<div class="modal fade" id="tokenmanager" tabindex="-1" role="dialog">
		<div class="modal-dialog modal-lg" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
					<h4 class="modal-title">Token管理</h4>
				</div>
				<div class="modal-body">
					<input type="hidden" id="tokenMealId" value="">
					<div class="form-group">
						<label class="control-label">套餐名称：</label>
						<span id="tokenMealName"></span>
					</div>
					<div class="form-group">
						<button class="btn btn-primary" type="button" id="createTokenBtn" onclick="createToken()">创建新Token</button>
						<input type="text" class="form-control" id="tokenRemark" placeholder="备注（可选）" style="display: inline-block; width: 200px; margin-left: 10px;">
						<input type="number" class="form-control" id="tokenExpireDays" placeholder="有效期天数（可选）" style="display: inline-block; width: 150px; margin-left: 10px;">
					</div>
					<div class="form-group">
						<table class="table table-bordered table-striped table-vcenter" id="tokenTable">
							<thead>
								<tr>
									<th>Token</th>
									<th>备注</th>
									<th>创建时间</th>
									<th>有效期</th>
									<th>状态</th>
									<th>操作</th>
								</tr>
							</thead>
							<tbody id="tokenTableBody">
								<!-- Token列表将通过JavaScript动态填充 -->
							</tbody>
						</table>
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
				</div>
			</div>
		</div>
	</div>
<script>
	// 配置toastr默认选项
	toastr.options = {
		"closeButton": true,
		"debug": false,
		"newestOnTop": false,
		"progressBar": true,
		"positionClass": "toast-top-right",
		"preventDuplicates": false,
		"onclick": null,
		"showDuration": "300",
		"hideDuration": "1000",
		"timeOut": "5000",
		"extendedTimeOut": "1000",
		"showEasing": "swing",
		"hideEasing": "linear",
		"showMethod": "fadeIn",
		"hideMethod": "fadeOut"
	}
		// 管理套餐tokens
		function manageTokens(button) {
			var mealId = $(button).val();
			var mealName = $(button).closest('tr').find('.meal-name').data('value');

			$('#tokenMealId').val(mealId);
			$('#tokenMealName').text(mealName);

			// 加载该套餐的所有tokens
			loadMealTokens(mealId);
		}

		// 加载套餐的所有tokens
		function loadMealTokens(mealId) {
			$.ajax({
				url: '/admin/meals/' + mealId + '/tokens',
				type: 'GET',
				dataType: 'json',
				success: function(response) {
					if (response.code === 1) {
						var tokens = response.data.tokens;
						var tokenTableBody = $('#tokenTableBody');
						tokenTableBody.empty();

						if (tokens.length === 0) {
							tokenTableBody.append('<tr><td colspan="5" class="text-center">暂无Token</td></tr>');
						} else {
							$.each(tokens, function(index, token) {
								var statusText = token.status === 1 ? '<span class="label label-success">启用</span>' : '<span class="label label-danger">禁用</span>';
								var createdAt = new Date(token.created_at * 1000).toLocaleString();
								var expireText = '';
								if (token.expires_at === 0) {
									expireText = '永久有效';
								} else {
									var expireDate = new Date(token.expires_at * 1000);
									var now = new Date();
									var daysLeft = Math.ceil((expireDate - now) / (1000 * 60 * 60 * 24));
									if (daysLeft < 0) {
										expireText = '已过期';
									} else {
										expireText = expireDate.toLocaleString() + ' (' + daysLeft + '天后过期)';
									}
								}
								var row = '<tr>' +
									'<td><input type="text" class="form-control" value="' + token.token + '" readonly style="width: 200px;"></td>' +
									'<td>' + (token.remark || '') + '</td>' +
									'<td>' + createdAt + '</td>' +
									'<td>' + expireText + '</td>' +
									'<td>' + statusText + '</td>' +
									'<td>' +
										'<button class="btn btn-xs btn-info" onclick="showCopyLinkModal(this)">复制</button>' +
										'<button class="btn btn-xs btn-warning" onclick="toggleTokenStatus(' + token.id + ', ' + (token.status === 1 ? 0 : 1) + ')">' + (token.status === 1 ? '禁用' : '启用') + '</button> ' +
										'<button class="btn btn-xs btn-success extend-btn" onclick="extendToken(' + token.id + ')" data-token-id="' + token.id + '">延期</button> ' +
										'<button class="btn btn-xs btn-danger" onclick="deleteToken(' + token.id + ')">删除</button>' +
									'</td>' +
								'</tr>';
								tokenTableBody.append(row);
							});
						}
					} else {
						toastr.error('获取Token列表失败: ' + response.msg);
					}
				},
				error: function() {
					toastr.error('获取Token列表失败');
				}
			});
		}

		// 创建新Token
		function createToken() {
			var mealId = $('#tokenMealId').val();
			var remark = $('#tokenRemark').val();
			var expireDays = $('#tokenExpireDays').val();

			$.ajax({
				url: '/admin/meals/' + mealId + '/tokens',
				type: 'POST',
				data: {
					remark: remark,
					expire_days: expireDays
				},
				dataType: 'json',
				success: function(response) {
					if (response.code === 1) {
						toastr.success('创建Token成功');
						$('#tokenRemark').val('');
						$('#tokenExpireDays').val('');
						loadMealTokens(mealId);
					} else {
						toastr.error('创建Token失败: ' + response.msg);
					}
				},
				error: function() {
					toastr.error('创建Token失败');
				}
			});
		}

		
		// 切换Token状态
		function toggleTokenStatus(tokenId, status) {
			var mealId = $('#tokenMealId').val();

			$.ajax({
				url: '/admin/meals/tokens/' + tokenId + '/status',
				type: 'POST',
				data: { status: status },
				dataType: 'json',
				success: function(response) {
					if (response.code === 1) {
						toastr.success('更新Token状态成功');
						loadMealTokens(mealId);
					} else {
						toastr.error('更新Token状态失败: ' + response.msg);
					}
				},
				error: function() {
					toastr.error('更新Token状态失败');
				}
			});
		}

		// 删除Token
		function deleteToken(tokenId) {
			if (!confirm('确定要删除这个Token吗？')) {
				return;
			}

			var mealId = $('#tokenMealId').val();

			$.ajax({
				url: '/admin/meals/tokens/' + tokenId,
				type: 'DELETE',
				dataType: 'json',
				success: function(response) {
					if (response.code === 1) {
						toastr.success('删除Token成功');
						loadMealTokens(mealId);
					} else {
						toastr.error('删除Token失败: ' + response.msg);
					}
				},
				error: function() {
					toastr.error('删除Token失败');
				}
			});
		}

		// 延期Token
		function extendToken(tokenId) {
			var extendDays = prompt('请输入要延期的天数：');
			if (extendDays === null || extendDays === '') {
				return;
			}

			// 验证输入是否为数字
			if (!/^\d+$/.test(extendDays) || parseInt(extendDays) <= 0) {
				toastr.error('请输入有效的天数');
				return;
			}

			var mealId = $('#tokenMealId').val();

			$.ajax({
				url: '/admin/meals/tokens/' + tokenId + '/extend',
				type: 'POST',
				data: {
					extend_days: extendDays,
					token_id: tokenId
				},
				dataType: 'json',
				success: function(response) {
					if (response.code === 1) {
						toastr.success('延期Token成功');
						loadMealTokens(mealId);
					} else {
						toastr.error('延期Token失败: ' + response.msg);
					}
				},
				error: function() {
					toastr.error('延期Token失败');
				}
			});
		}
	// 显示复制链接格式选择模态框
		function showCopyLinkModal(button) {
			var tokenInput = $(button).closest('tr').find('input[type="text"]');
			var tokenId = $(button).closest('tr').find('.btn-warning, .btn-success').attr('onclick').match(/toggleTokenStatus\((\d+)/)[1];
			var tokenValue = tokenInput.val();

			$('#currentTokenId').val(tokenId);
			$('#currentTokenValue').val(tokenValue);
			$('#tokenValueDisplay').val(tokenValue);

			// 清除之前的选中状态
			$('input[name="linkFormat"]').prop('checked', false);
			$('input[name="linkFormat"][value="token"]').prop('checked', true);

			$('#copyLinkModal').modal('show');
		}

		// 复制选中的链接格式
		function copySelectedLink() {
			var tokenId = $('#currentTokenId').val();
			var tokenValue = $('#currentTokenValue').val();
			var selectedFormat = $('input[name="linkFormat"]:checked').val();

			if (selectedFormat === 'token') {
				// 直接复制token
				copyTextToClipboard(tokenValue);
				toastr.success('Token已复制到剪贴板');
				$('#copyLinkModal').modal('hide');
			} else {
				// 获取对应的链接格式
				var mealId = $('#tokenMealId').val();
				$.ajax({
					url: '/admin/getRssUrl',
					type: 'POST',
					data: {
						id: mealId
					},
					dataType: 'json',
					success: function(response) {
						if (response.type === "success") {
							var linkUrl = '';
							response.data.forEach(function(item) {
								if ((selectedFormat === 'txt' && item.type === 'txt') ||
									(selectedFormat === 'm3u' && item.type === 'm3u8') ||
									(selectedFormat === 'ku9' && item.type === 'ku9')) {
									linkUrl = item.url.replace('{token}', tokenValue);
								}
							});

							if (linkUrl) {
								copyTextToClipboard(linkUrl);
								toastr.success('链接已复制到剪贴板');
							} else {
								toastr.error('未找到对应的链接格式');
							}
							$('#copyLinkModal').modal('hide');
						} else {
							toastr.error('获取链接失败: ' + response.msg);
						}
					},
					error: function() {
						toastr.error('获取链接失败');
						$('#copyLinkModal').modal('hide');
					}
				});
			}
		}

		// 复制文本到剪贴板的辅助函数
		function copyTextToClipboard(text) {
			var tempInput = $('<input>');
			$('body').append(tempInput);
			tempInput.val(text).select();
			document.execCommand('copy');
			tempInput.remove();
		}
	</script>

<!-- 复制链接格式选择模态框 -->
<div class="modal fade" id="copyLinkModal" tabindex="-1" role="dialog">
	<div class="modal-dialog" role="document">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
				<h4 class="modal-title">选择链接格式</h4>
			</div>
			<div class="modal-body">
				<input type="hidden" id="currentTokenId" value="">
				<input type="hidden" id="currentTokenValue" value="">
				<div class="form-group">
					<label class="control-label">Token：</label>
					<input type="text" class="form-control" id="tokenValueDisplay" readonly>
				</div>
				<div class="form-group">
					<label class="control-label">选择链接格式：</label>
					<div class="radio">
						<label>
							<input type="radio" name="linkFormat" value="token" checked>
							仅复制Token
						</label>
					</div>
					<div class="radio">
						<label>
							<input type="radio" name="linkFormat" value="txt">
							TXT格式链接
						</label>
					</div>
					<div class="radio">
						<label>
							<input type="radio" name="linkFormat" value="m3u">
							M3U格式链接
						</label>
					</div>
					<div class="radio">
						<label>
							<input type="radio" name="linkFormat" value="ku9">
							酷9TXT格式链接
						</label>
					</div>
				</div>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-primary" onclick="copySelectedLink()">复制</button>
				<button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
			</div>
		</div>
	</div>
</div>

</main>
{{ template "admin_footer" . }}